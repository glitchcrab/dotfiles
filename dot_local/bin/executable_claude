#!/usr/bin/env bash

# get the current directory
CURRENT_DIR_PATH="${PWD##}"
CURRENT_DIR_NAME="${PWD##*/}"
BASE_DIR="${HOME}/temp/bubblewrap"
_UID=$(id -u)

bwrap \
    --ro-bind /usr /usr \
    --ro-bind /lib /lib \
    --ro-bind /lib64 /lib64 \
    --ro-bind /bin /bin \
    --ro-bind /etc/resolv.conf /etc/resolv.conf \
    --ro-bind /etc/hosts /etc/hosts \
    --ro-bind /etc/ssl /etc/ssl \
    --ro-bind /etc/ca-certificates /etc/ca-certificates \
    --ro-bind /usr/share/ca-certificates /usr/share/ca-certificates \
    --ro-bind /opt/claude-code /opt/claude-code \
    --bind "${HOME}/.claude" "${HOME}/.claude" \
    --bind "${HOME}/.claude.json" "${HOME}/.claude.json" \
    --bind "${HOME}/.vscode/" "${HOME}/.vscode/" \
    --bind $XDG_RUNTIME_DIR/podman/podman.sock /run/podman.sock \
    --setenv CONTAINER_HOST unix:///run/podman.sock \
    --bind "/run/user/${_UID}/libpod" "/run/user/${_UID}/libpod" \
    --tmpfs /tmp \
    --proc /proc \
    --dev /dev \
    --share-net \
    --unshare-pid \
    --die-with-parent \
    --bind "${CURRENT_DIR_PATH}" "${BASE_DIR}/${CURRENT_DIR_NAME}" \
    --chdir "${BASE_DIR}/${CURRENT_DIR_NAME}" \
    /usr/bin/claude "$@" # start Claude and pass all arguments through
